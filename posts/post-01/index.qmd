---
title: "000-DataTable"
date: "2024-08-04"
categories: [tools]
image: "image.jpg"
format: 
  html:
    page-layout: full
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error=TRUE, cache=FALSE)
```

```{r}
library(tidyverse)
library(DT)
library(here)
library(gt)
library(ggthemes)
library(ggridges)
library(gt)
library(gtExtras)
theme_set(theme_solarized())

```

```{r}
url <- "https://fantasy.premierleague.com/api/bootstrap-static/"
data_official_list <- httr::content(httr::GET(url))

fixtures_list <- httr::content(httr::GET("https://fantasy.premierleague.com/api/fixtures/"))
#mainDf <- data.table::rbindlist(data_official$elements) %>% tibble()
#playersTypes <- rbindlist(data_official$element_types) %>% tibble()
fixtures_df <- data.table::rbindlist(fixtures_list) %>% tibble()
```

```{r}
teams <- read_csv(here("posts","post-01","teams.csv"))

players_2023_df_raw <- read_csv(here("posts","post-01","merged_gw.csv")) 

```

```{r}
players_2023_df <- players_2023_df_raw %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  mutate(
    total_points_season=sum(total_points, na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  left_join(teams %>% dplyr::select(id, opponent_team_name=short_name), by=c("opponent_team"="id"))


```

```{r}
players_summary_df <- players_2023_df_raw %>% 
  filter(minutes>0) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name,position) %>% 
  summarize(
    total_points_season=sum(total_points, na.rm = TRUE),
    minutes_total=sum(minutes, na.rm = T),
    xG=sum(expected_goals, na.rm = T),
    xA=sum(expected_assists, na.rm = T),
    xGI=sum(expected_goal_involvements, na.rm = T),
    Goals=sum(goals_scored, na.rm = T),
    Assists=sum(assists, na.rm = T),
    GI=sum(goals_scored, na.rm = T)+sum(assists, na.rm = T),
    starts=sum(starts)
  ) %>% 
  ungroup() %>% 
  arrange(desc(total_points_season)) %>% 
  slice_max(order_by = total_points_season, n=200) %>% 
  mutate(
    xG_per90=xG/minutes_total*90,
    xA_per90=xA/minutes_total*90,
    xGI_per90=xGI/minutes_total*90,
    Goals_per90=Goals/minutes_total*90,
    Assists_per90=Assists/minutes_total*90,
    GI_per90=GI/minutes_total*90,
    total_points_average=total_points_season/minutes_total*90
  )

```

```{r}
players_2023_df2 <- players_2023_df %>% 
  semi_join(players_summary_df, by=c("name")) %>% 
  arrange(name,team,position,GW) %>% 
  mutate(
    name=fct_reorder(name, total_points_season)
  ) %>% 
  arrange(desc(name))


```

```{r}

ceiling_df <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  slice_max(order_by = total_points, n= 10) %>% 
  arrange(desc(total_points_season)) %>% 
  group_by(name) %>% 
  summarize(
    ceiling= mean(total_points)
  ) %>% 
  arrange(desc(ceiling)) 

```

```{r}
high_df <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  slice_max(order_by = total_points, n= 20) %>% 
  arrange(desc(total_points_season)) %>% 
  group_by(name) %>% 
  summarize(
    high= mean(total_points)
  ) %>% 
  arrange(desc(high)) 

```

```{r}
max_df <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  slice_max(order_by = total_points, n= 5) %>% 
  arrange(desc(total_points_season)) %>% 
  group_by(name) %>% 
  summarize(
    max= mean(total_points)
  ) %>% 
  arrange(desc(max)) 
```

```{r}
max3_df <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  slice_max(order_by = total_points, n= 3) %>% 
  arrange(desc(total_points_season)) %>% 
  group_by(name) %>% 
  summarize(
    max= mean(total_points)
  ) %>% 
  arrange(desc(max)) 
```

```{r}
max_df_opp1 <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  arrange(desc(total_points)) %>% 
  slice_head(n= 1) %>% 
  arrange(desc(total_points_season))  %>% 
  transmute(name, max1 =if_else(was_home==TRUE,str_to_upper(opponent_team_name),str_to_lower(opponent_team_name)))
```

```{r}
max_df_opp2 <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  arrange(desc(total_points)) %>% 
  slice_head(n= 2) %>% 
  slice_tail(n=1) %>% 
  arrange(desc(total_points_season))  %>% 
  transmute(name, max2 =if_else(was_home==TRUE,str_to_upper(opponent_team_name),str_to_lower(opponent_team_name)))
```

```{r}
max_df_opp3 <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  arrange(desc(total_points)) %>% 
  slice_head(n= 3) %>% 
  slice_tail(n=1) %>% 
  arrange(desc(total_points_season))  %>% 
  transmute(name, max3 =if_else(was_home==TRUE,str_to_upper(opponent_team_name),str_to_lower(opponent_team_name)))
```

```{r}
max_df_opp4 <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  arrange(desc(total_points)) %>% 
  slice_head(n= 4) %>% 
  slice_tail(n=1) %>% 
  arrange(desc(total_points_season))  %>% 
  transmute(name, max4 =if_else(was_home==TRUE,str_to_upper(opponent_team_name),str_to_lower(opponent_team_name)))

```

```{r}
max_df_opp5 <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  arrange(desc(total_points)) %>% 
  slice_head(n= 5) %>% 
  slice_tail(n=1) %>% 
  arrange(desc(total_points_season))  %>% 
  transmute(name, max5 =if_else(was_home==TRUE,str_to_upper(opponent_team_name),str_to_lower(opponent_team_name)))
```

```{r}
mean_df <- players_2023_df2 %>% 
  filter(minutes>0, starts==1) %>% 
  mutate(
    is_played= if_else(minutes>0, 1,0),
    
  ) %>% 
  #filter(position != "GK") %>% 
  #filter(starts==TRUE) %>% 
  relocate(name,team,position,GW, total_points) %>% 
  group_by(name) %>% 
  summarize(
    mean= mean(total_points)
  ) %>% 
  arrange(desc(mean)) 

```

```{r}
xG_df0 <- players_summary_df %>% 
  #filter(starts>15) %>% 
  #slice_max(order_by = total_points_season, n=10) %>% 
  select(name, xG_per90,Goals_per90, xA_per90, Assists_per90, starts, total_points_season, Goals, Assists, position) %>% 
  mutate(
    xG_Delta= (Goals_per90-xG_per90),
    xA_Delta= (Assists_per90-xA_per90)
  ) %>% 
  left_join(mean_df, by = "name") %>% 
  left_join(high_df, by = "name") %>% 
  left_join(ceiling_df, by = "name") %>% 
  left_join(max_df, by = "name") %>% 
  mutate(
    across(c(xG_per90,Goals_per90, xA_per90, Assists_per90,xG_Delta,xA_Delta, mean,high, ceiling, max), ~round(.x,2))
  ) %>% 
  mutate(
    across(c(mean,high, ceiling, max), ~round(.x,1))
  ) %>% 
  dplyr::mutate(plot_column = max, target_col=mean) %>% 
  left_join(max_df_opp1, by="name") %>% 
  left_join(max_df_opp2, by="name") %>% 
  left_join(max_df_opp3, by="name") %>% 
  left_join(max_df_opp4, by="name") %>% 
  left_join(max_df_opp5, by="name") %>% 
  mutate(across(max1:max5, ~ str_sub(.x,1,3))) 

xG_df <- xG_df0 %>% 
  select(-position)

```

```{r}
players_2023_df_density <- players_2023_df %>% 
  filter(starts==TRUE) %>% 
  group_by(name) %>% 
  summarize(total_points_list=list(total_points)) %>% 
  semi_join(xG_df , by="name")

# players_2023_df_density_gt <- players_2023_df_density %>% 
#   gt() %>% 
#   gt_plt_dist(total_points_list, type="boxplot")

#players_2023_df_density_gt
```

## DataTable

```{r eval=TRUE}
xG_df2 <- xG_df0 %>% 
  transmute(
    name, position,starts,xG_per90,xA_per90,xG_Delta,xA_Delta,
    mean_perStart=mean, mean_max20=high, mean_max10=ceiling, mean_max5= max,
    total_points_season, Goals, Assists,
  )


datatable(xG_df2,filter = 'top',extensions = "FixedColumns",rownames = FALSE,
          options = list(
            paging = TRUE,
            scrollX=TRUE, 
            searching = TRUE,
            ordering = TRUE,
            dom = 'Bfrtip',
            #buttons = c('copy', 'csv', 'excel', 'pdf'),
            buttons = c('pdf'),
            pageLength=10, 
            lengthMenu=c(3,5,10) ,
            fixedColumns = list(leftColumns = 1)
          )
)
```

```{r eval=FALSE}
datatable(xG_df2,filter = 'top', extensions = "Buttons", 
          options = list(
            paging = TRUE,
            scrollX=TRUE, 
            searching = TRUE,
            ordering = TRUE,
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf'),
            pageLength=10, 
            lengthMenu=c(3,5,10) 
          )
)
```
